<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TLV Parser</title>
</head>
<body>
  <h1>Upload .bin File to Parse TLV</h1>
  <input type="file" id="fileInput" accept=".bin" />
  <pre id="output"></pre>

  <script>
    const output = document.getElementById("output");

    function log(msg) {
      console.log(msg);
      output.textContent += msg + "\n";
    }

    function readUint64LE(dataView, offset) {
      const low = dataView.getUint32(offset, true);
      const high = dataView.getUint32(offset + 4, true);
      return high * 2 ** 32 + low;
    }

    function parseDetectedObjects(view, offset, tlvLength) {
      const numDetectedObj = view.getUint16(offset, true);
      const xyzQFormat = view.getUint16(offset + 2, true);
      log(`\tDetect Obj:\t${numDetectedObj}`);
      offset += 4;
      for (let i = 0; i < numDetectedObj; i++) {
        const rangeIdx = view.getUint16(offset + i * 12, true);
        const dopplerIdx = view.getUint16(offset + i * 12 + 2, true);
        const peakVal = view.getUint16(offset + i * 12 + 4, true);
        const x = view.getInt16(offset + i * 12 + 6, true);
        const y = view.getInt16(offset + i * 12 + 8, true);
        const z = view.getInt16(offset + i * 12 + 10, true);
        const scale = 1.0 / (1 << xyzQFormat);
        const range = Math.sqrt((x * scale) ** 2 + (y * scale) ** 2);
        log(`\tObjId:\t${i}`);
        log(`\t\tDopplerIdx:\t${dopplerIdx}`);
        log(`\t\tRangeIdx:\t${rangeIdx}`);
        log(`\t\tPeakVal:\t${peakVal}`);
        log(`\t\tX:\t\t${(x * scale).toFixed(3)}`);
        log(`\t\tY:\t\t${(y * scale).toFixed(3)}`);
        log(`\t\tZ:\t\t${(z * scale).toFixed(3)}`);
        log(`\t\tRange:\t\t${range.toFixed(3)}m`);
      }
    }

    function parseRangeProfile(view, offset, tlvLength) {
      for (let i = 0; i < 256; i++) {
        const val = view.getUint16(offset + i * 2, true);
        const result = val * 6 / 8 / (1 << 8);
        log(`\tRangeProf[${i}]:\t${result.toFixed(3)}`);
      }
      log(`\tTLVType:\t2`);
    }

    function parseStats(view, offset, tlvLength) {
      const interProcess = view.getUint32(offset, true);
      const transmitOut = view.getUint32(offset + 4, true);
      const frameMargin = view.getUint32(offset + 8, true);
      const chirpMargin = view.getUint32(offset + 12, true);
      const activeCPULoad = view.getUint32(offset + 16, true);
      const interCPULoad = view.getUint32(offset + 20, true);
      log(`\tOutputMsgStats:\t6`);
      log(`\t\tChirpMargin:\t${chirpMargin}`);
      log(`\t\tFrameMargin:\t${frameMargin}`);
      log(`\t\tInterCPULoad:\t${interCPULoad}`);
      log(`\t\tActiveCPULoad:\t${activeCPULoad}`);
      log(`\t\tTransmitOut:\t${transmitOut}`);
      log(`\t\tInterprocess:\t${interProcess}`);
    }

    function parseTLV(buffer) {
      const view = new DataView(buffer);
      const magic = [0x02, 0x01, 0x04, 0x03, 0x06, 0x05, 0x08, 0x07];
      let offset = 0;

      // Find magic
      while (offset < view.byteLength - 8) {
        let found = true;
        for (let i = 0; i < 8; i++) {
          if (view.getUint8(offset + i) !== magic[i]) {
            found = false;
            break;
          }
        }
        if (found) break;
        offset++;
      }

      while (offset + 40 < view.byteLength) {
        try {
          const magicVal = readUint64LE(view, offset);
          const version = view.getUint32(offset + 8, true);
          const length = view.getUint32(offset + 12, true);
          const platform = view.getUint32(offset + 16, true);
          const frameNum = view.getUint32(offset + 20, true);
          const numObj = view.getUint32(offset + 28, true);
          const numTLVs = view.getUint32(offset + 32, true);
          log(`Packet ID:\t${frameNum}`);
          log(`Version:\t0x${version.toString(16)}`);
          log(`TLV:\t\t${numTLVs}`);
          log(`Detect Obj:\t${numObj}`);
          log(`Platform:\t0x${platform.toString(16)}`);

          let headerLength = 36;
          if (version > 0x01000005) {
            const subFrameNum = view.getUint32(offset + 36, true);
            headerLength = 40;
            log(`Subframe:\t${subFrameNum}`);
          }

          let cursor = offset + headerLength;
          for (let i = 0; i < numTLVs; i++) {
            const tlvType = view.getUint32(cursor, true);
            const tlvLength = view.getUint32(cursor + 4, true);
            cursor += 8;

            if (tlvType === 1) {
              parseDetectedObjects(view, cursor, tlvLength);
            } else if (tlvType === 2) {
              parseRangeProfile(view, cursor, tlvLength);
            } else if (tlvType === 6) {
              parseStats(view, cursor, tlvLength);
            } else {
              log(`Unidentified tlv type ${tlvType}`);
            }

            cursor += tlvLength;
          }

          offset += length;
          log("");
        } catch (e) {
          log("Error parsing TLV block: " + e.message);
          break;
        }
      }
    }

    document.getElementById("fileInput").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const arrayBuffer = e.target.result;
        parseTLV(arrayBuffer);
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
